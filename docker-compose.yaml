name: klikkikuri

services:
  meri:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    command: python -m meri run
    volumes:
      - ./instance:/app/instance:rw,cached
      #- ./:/app:rw,cached
      - /app/.venv
    environment:
      KLIKKIKURI_CONFIG_FILE: ${KLIKKIKURI_CONFIG_FILE:-/app/packages/rahti/config.yaml}
    networks:
      - meri
    env_file:
      - .env

  development:
    extends:
      service: meri
    build: 
      context: .
      dockerfile: Dockerfile
      target: development

    environment:
      - PYTHONDONTWRITEBYTECODE=1
      - OTEL_PYTHON_LOGGING_AUTO_INSTRUMENTATION_ENABLED=true
      - OTEL_METRICS_EXPORTER=otlp
      - OTEL_LOGS_EXPORTER=otlp
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4318/v1/traces
      # - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4317  # OpenTelemetry gRPC
    command: /bin/bash

    volumes:
      - .:/app:cached
      - /app/.venv

    # develop:
    #   # Create a `watch` configuration to update the app
    #   # https://docs.docker.com/compose/file-watch/#compose-watch-versus-bind-mounts
    #   watch:
    #     # Sync the working directory with the `/app` directory in the container
    #     - action: sync
    #       path: .
    #       target: /app
    #       # Exclude the project virtual environment â€” it could be for a
    #       # different platform in the container
    #       ignore:
    #         - .venv/

    #     # Rebuild the image on changes to the `pyproject.toml`
    #     - action: rebuild
    #       path: ./pyproject.toml

  jaeger:
    image: jaegertracing/all-in-one:1.62.0
    environment:
      - COLLECTOR_OTLP_ENABLED=true
      - COLLECTOR_ZIPKIN_HOST_PORT=:9411
      # # Storage
      # - SPAN_STORAGE_TYPE=badger
      # - BADGER_EPHEMERAL=false
      # - BADGER_DIRECTORY_VALUE=/badger/data
      # - BADGER_DIRECTORY_KEY=/badger/key
    # volumes:
    #   - jaeger-data:/badger
    ports:
      - "16686:16686"  # Jaeger UI
    expose:
      - 4317  # OpenTelemetry gRPC
      - 4318  # OpenTelemetry HTTP
    networks:
      - meri

networks:
  meri:
    name: meri

# volumes:
  # s3-data: {}
  # jaeger-data: {}
